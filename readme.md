# Подробный отчет по анализу временных рядов и выявлению аномалий

Этот отчет представляет собой всесторонний обзор анализа временных рядов и выявления аномалий, выполненного в предоставленном Jupyter Notebook (`Final + tsai v3.ipynb`). 

## 1. Цели

Основные цели анализа:

1. **Исследовательский анализ данных (EDA):** Изучение структуры, закономерностей и характеристик набора данных о такси в Нью-Йорке, включая тренды, сезонность и стационарность.
2. **Выявление аномалий:** Определение выбросов во временном ряде с использованием нескольких статистических и машинных методов.
3. **Прогнозирование временных рядов (опционально):** Хотя в предоставленном коде это не полностью реализовано, наличие библиотек прогнозирования указывает на намерение предсказывать будущие количества поездок.
4. **Классификация (опционально):** Некоторые части кода намекают на задачи классификации, возможно, для категоризации временных периодов по шаблонам поездок, но это не полностью разработано в предоставленных ячейках.

Анализ использует множество библиотек Python, включая `pandas`, `numpy`, `matplotlib`, `seaborn`, `statsmodels`, `sktime`, `sklearn` и `tsai` (если доступно), для выполнения этих задач.

## 2. Методология

### 2.1 Загрузка и предварительная обработка данных

Набор данных (`nyc_taxi.csv`) содержит два столбца:
- **timestamp**: Дата и время количества поездок на такси с интервалом в 30 минут.
- **value**: Количество поездок на такси за каждый интервал.

**Выполненные шаги:**
- Загрузка данных с помощью `pandas`.
- Преобразование столбца `timestamp` в формат даты и времени и установка его в качестве индекса.
- Установка частоты данных на 30 минут (`30T`) с помощью `asfreq`.
- Проверка на наличие пропущенных значений и расчет базовых статистик (например, среднее, стандартное отклонение).
- Опциональное включение режима малого образца (`USE_SMALL_SAMPLE`) для ограничения количества точек данных в тестовых целях.

**Ключевые параметры:**
- `FREQ = '30T'`: Частота 30 минут.
- `NEW_SP_WEEKLY = 42`: Недельная сезонность (42 точки в неделю, предполагается пользовательское определение).
- `NEW_SP_DAILY = NEW_SP_WEEKLY / 7`: Дневная сезонность (6 точек в день).
- `TEST_SIZE_RATIO = 0.2`: 20% данных зарезервированы для тестирования в задачах прогнозирования.
- `SMALL_SAMPLE_SIZE_TS = 336`: Количество точек (8 недель) для анализа малого образца.

**Результаты:**
- Набор данных содержит 10,320 записей (примерно 5 месяцев данных с интервалом в 30 минут).
- Пропущенные значения отсутствуют после установки частоты.
- Базовые статистики:
  - Среднее количество поездок: 15,137.57
  - Стандартное отклонение: 6,939.50
  - Минимум: 8 поездок
  - Максимум: 39,197 поездок

**Визуализация:**
Был создан начальный график временного ряда для визуализации количества поездок во времени.

![Начальный график временного ряда](attachment://plot_анализ_ряда.png)

*Рисунок 1: Начальный график временного ряда количества поездок на такси в Нью-Йорке, показывающий дневные и недельные закономерности.*

### 2.2 Выявление аномалий

Для выявления аномалий были использованы три метода:

#### 2.2.1 Z-оценка (скользящая)
- **Метод**: Рассчитывались скользящее среднее и стандартное отклонение на окне из 6 точек (3 часа). Точки с абсолютными z-оценками, превышающими 3 стандартных отклонения, помечались как аномалии.
- **Цель**: Выявление выбросов на основе статистического отклонения от локального среднего, подходит для нормально распределенных данных без сильных трендов или сезонности.
- **Параметры**:
  - Размер окна: 6 точек (3 часа).
  - Порог: 3 стандартных отклонения.
- **Результаты**: Аномалии не обнаружены (`0 аномалий`), вероятно, из-за наличия сильной сезонности или трендов, с которыми метод не справился.
- **Визуализация**: График был создан, но не показал красных маркеров (аномалий).

![График аномалий Z-оценки](attachment://plot_Аномалии_Z_score.png)
![График аномалий Z-оценки](plot_anomalies_z_score.png)

*Рисунок 2: График выявления аномалий с помощью Z-оценки. Аномалии не были обнаружены.*

#### 2.2.2 Изолирующий лес
- **Метод**: Использовался алгоритм `IsolationForest` из `sklearn`, который изолирует наблюдения, случайным образом выбирая признаки и значения разделения. Аномалии — это точки, требующие меньшего количества разделений для изоляции.
- **Цель**: Выявление аномалий в многомерных данных без предположений о распределении, устойчиво к трендам и сезонности.
- **Параметры**:
  - `contamination='auto'`: Автоматическое определение доли выбросов.
- **Результаты**: Обнаружено 4,921 аномалий, что является высоким числом и указывает на возможную избыточную чувствительность или неправильную настройку параметра `contamination`.
- **Визуализация**: График показал множество красных маркеров, указывающих на широкое выявление аномалий.

![График аномалий изолирующего леса](attachment://plot_Аномалии_Isolation_Forest.png)

*Рисунок 3: График выявления аномалий с помощью изолирующего леса, показывающий 4,921 аномалий (красные маркеры).*

#### 2.2.3 Локальный фактор выбросов (LOF)
- **Метод**: Применялся алгоритм `LocalOutlierFactor` из `sklearn`, который измеряет отклонение локальной плотности точки по сравнению с ее соседями. Точки с существенно меньшей плотностью помечаются как аномалии.
- **Цель**: Выявление локальных аномалий, отклоняющихся от ближайших соседей, эффективно для обнаружения контекстных выбросов.
- **Параметры**:
  - `n_neighbors=20`: Учитывались 20 ближайших соседей для расчета плотности.
  - `contamination='auto'`: Автоматическое определение доли выбросов.
- **Результаты**: Обнаружен彼此: 19 аномалий, что является более разумным числом по сравнению с изолирующим лесом, что указывает на лучшую специфичность для локальных отклонений.
- **Визуализация**: График выделил 19 красных маркеров, фокусируясь на конкретных пиках или спадах.

![График аномалий LOF](attachment://plot_Аномалии_Local_Outlier_Factor.png)

*Рисунок 4: График выявления аномалий с помощью локального фактора выбросов (LOF), показывающий 19 аномалий (красные маркеры).*

### 2.3 Отчет по выявлению аномалий

Код завершился составлением отчета о результатах выявления аномалий, гипотезами о причинах аномалий и обоснованием выбора методов.

**Сводка результатов:**
- **Z-оценка (скользящая)**: 0 аномалий. Вероятно, неэффективна из-за сезонности/трендов.
- **Изолирующий лес**: 4,921 аномалий. Слишком чувствителен, возможно, из-за неправильной настройки `contamination`.
- **Локальный фактор выбросов**: 19 аномалий. Более избирателен, эффективно фиксирует локальные отклонения.

**Гипотезы причин аномалий:**
- **Пики/спады**: Вероятно, вызваны внешними событиями (например, праздники, аварии, погодные условия).
- **Низкие значения**: Возможные ошибки сбора данных или периоды низкой активности (например, поздние ночные часы).
- **Необходим контекст**: Точная интерпретация требует знаний о домене (например, конкретные события в Нью-Йорке в период данных).

**Обоснование выбора методов:**
- **Z-оценка**: Проста и интерпретируема, но предполагает нормальность и плохо справляется с трендами/сезонностью.
- **Изолирующий лес**: Устойчив для сложных данных, но чувствителен к настройке параметров (например, `contamination`).
- **LOF**: Эффективен для локальных аномалий, но требует тщательного выбора `n_neighbors` и `contamination`.

## 3. Результаты и находки

### 3.1 Характеристики данных
- Набор данных о такси в Нью-Йорке демонстрирует четкую **дневную и недельную сезонность**, с более высокими количествами поездок в дневное время и в будние дни, и более низкими в ночное время и в выходные.
- Данные являются **нестационарными**, что указывает на наличие трендов и сезонности (формальные тесты, такие как ADF, не показаны в предоставленном коде, но подразумеваются использованием `statsmodels.tsa.stattools.adfuller`).
- Среднее количество поездок (15,137.57) и высокое стандартное отклонение (6,939.50) предполагают значительную вариабельность, вероятно, вызванную внешними факторами, такими как время суток, день недели или особые события.

### 3.2 Эффективность выявления аномалий
- **Z-оценка**: Не смогла выявить аномалии, вероятно, из-за того, что подход со скользящим окном не учитывал сезонность или тренды. Этот метод лучше подходит для данных, лишенных трендов или сезонности.
- **Изолирующий лес**: Обнаружил нереалистичное количество аномалий (4,921 из 10,320 точек, ~47.7%). Это указывает на слишком мягкую настройку `contamination='auto'`, которая пометила нормальные вариации как выбросы.
- **LOF**: Обнаружил управляемое количество аномалий (19, ~0.18% точек), фокусируясь на локальных отклонениях. Эти аномалии, вероятно, соответствуют необычным пикам или спадам (например, экстремальные количества поездок в определенные интервалы).

### 3.3 Визуальные инсайты
- Начальный график временного ряда (Рисунок 1) подтвердил сильные дневные и недельные закономерности, с пиками во время часов пик и спадами в ранние утренние часы.
- График изолирующего леса (Рисунок 3) показал избыточное выявление аномалий, с красными маркерами, разбросанными по ряду, что указывает на низкую специфичность.
- График LOF (Рисунок 4) выделил конкретные точки, такие как необычно высокие или низкие количества поездок, которые с большей вероятностью представляют истинные аномалии (например, всплески в праздники или ошибки данных).

## 4. Выводы

### 4.1 Ключевые выводы
- **Закономерности данных**: Набор данных о такси в Нью-Йорке имеет высокую сезонность, с дневными и недельными циклами, и является нестационарным из-за трендов и вариабельности.
- **Выявление аномалий**:
  - **Z-оценка**: Неэффективна для этого набора данных из-за неспособности учитывать сезонность. Предобработка (например, удаление трендов или сезонности) могла бы улучшить результаты.
  - **Изолирующий лес**: Слишком чувствителен, требует настройки параметров (например, установка конкретного значения `contamination` на основе знаний о домене).
  - **LOF**: Наиболее эффективен среди протестированных методов, выявляя небольшое количество правдоподобных аномалий. Выбор `n_neighbors=20` был разумным, но дальнейшая настройка могла бы улучшить результаты.
- **Чувствительность параметров**: Методы выявления аномалий очень чувствительны к параметрам, таким как `contamination`, `n_neighbors` и размер окна. Для оптимальных настроек необходимы экспертные знания или кросс-валидация.
- **Контекстная интерпретация**: Аномалии, вероятно, соответствуют внешним событиям (например, праздники, аварии) или проблемам с данными. Без дополнительного контекста (например, журналов событий) точные причины остаются спекулятивными.

### 4.2 Рекомендации
1. **Предобработка для Z-оценки**: Применить удаление трендов (например, дифференцирование) или десезонализацию (например, с использованием `seasonal_decompose`) перед использованием Z-оценки для повышения эффективности.
2. **Настройка изолирующего леса**: Экспериментировать с конкретными значениями `contamination` (например, 0.01–0.1) для уменьшения ложных срабатываний. Кросс-валидация или знания о домене могут помочь в этом процессе.
3. **Уточнение LOF**: Протестировать различные значения `n_neighbors` (например, 10, 30, 50) для балансировки чувствительности и специфичности. Рассмотреть включение дополнительных признаков (например, время суток, день недели) для многомерного LOF.
4. **Интеграция знаний о домене**: Получить внешние данные (например, календари событий в Нью-Йорке, данные о погоде) для валидации и интерпретации аномалий.
5. **Расширение прогнозирования**: Реализовать модели прогнозирования (например, SARIMAX, AutoETS или модели глубокого обучения `tsai`) для предсказания будущих количеств поездок и сравнения их производительности.
6. **Задачи классификации**: Если предполагается классификация, четко определить целевую переменную (например, периоды высокого и низкого спроса) и использовать классификаторы `sktime`, такие как `KNeighborsTimeSeriesClassifier` или `RocketClassifier`.

### 4.3 Будущая работа
- **Многомерный анализ**: Включить дополнительные признаки (например, погода, праздники, данные о трафике) для повышения точности выявления аномалий и прогнозирования.
- **Устойчивые методы выявления аномалий**: Исследовать продвинутые методы, такие как DBSCAN, One-Class SVM или выявление аномалий на основе глубокого обучения (например, модели `tsai`, если доступны).
- **Оценка моделей**: Использовать метрики, такие как точность, полнота и F1-оценка, для оценки производительности выявления аномалий, особенно если станут доступны истинные метки аномалий.
- **Интерактивная визуализация**: Разработать интерактивные панели (например, с использованием `plotly` или `dash`) для динамического исследования аномалий и прогнозов.

## 5. Структура кода и библиотеки

### 5.1 Используемые библиотеки
- **Манипуляция данными**: `pandas`, `numpy`
- **Визуализация**: `matplotlib`, `seaborn`
- **Анализ временных рядов**: `statsmodels` (для декомпозиции, ACF/PACF, SARIMAX), `sktime` (для прогнозирования и классификации)
- **Выявление аномалий**: `sklearn` (`IsolationForest`, `LocalOutlierFactor`)
- **Глубокое обучение (опционально)**: `tsai` (не использовалось в предоставленных ячейках из-за проверки импорта)
- **Метрики**: `sklearn.metrics`, `sktime.performance_metrics`

### 5.2 Организация кода
- **Импорт и настройка**: Загружены библиотеки и определены глобальные стили построения графиков (`plt.rcParams`, `sns.set`).
- **Конфигурация**: Определены константы (например, `FILE_PATH`, `FREQ`, `TEST_SIZE_RATIO`) для воспроизводимости.
- **Предобработка данных**: Обработаны загрузка данных, преобразование даты и времени и установка частоты.
- **Выявление аномалий**: Реализованы три метода (Z-оценка, изолирующий лес, LOF) с сохранением визуализаций в виде PNG-файлов.
- **Отчетность**: Составлен краткий отчет по выявлению аномалий с гипотезами и обоснованием методов.

### 5.3 Созданные артефакты
- **Графики**:
  - `plot_initial_time_series.png`: Начальная визуализация временного ряда.
  - `plot_Аномалии_Z_score.png`: График выявления аномалий с помощью Z-оценки.
  - `plot_Аномалии_Isolation_Forest.png`: График выявления аномалий с помощью изолирующего леса.
  - `plot_Аномалии_Local_Outlier_Factor.png`: График выявления аномалий с помощью LOF.
- **Данные**: Дополнительные файлы данных не создавались, но код предполагает использование `nyc_taxi.csv` в качестве входных данных.

## 6. Ограничения

- **Неудача Z-оценки**: Неэффективность метода подчеркивает необходимость предварительной обработки для удаления трендов и сезонности.
- **Избыточная чувствительность изолирующего леса**: Высокое количество аномалий указывает на необходимость лучшей настройки параметров или проектирования признаков.
- **Отсутствие контекста**: Без внешних данных интерпретация аномалий остается спекулятивной.
- **Неполное прогнозирование/классификация**: Код включает библиотеки для прогнозирования и классификации, но не реализует эти задачи в предоставленных ячейках.
- **Настройка параметров**: Параметры по умолчанию (например, `contamination='auto'`, `n_neighbors=20`) могут быть не оптимальными для этого набора данных.

## 7. Заключительные замечания

Анализ успешно исследовал набор данных о такси в Нью-Йорке, выявив сильные сезонные закономерности и протестировав три метода выявления аномалий. Метод LOF оказался наиболее эффективным, выявив 19 правдоподобных аномалий, в то время как Z-оценка не справилась из-за сезонности, а изолирующий лес был слишком чувствителен. Будущие улучшения должны сосредоточиться на предварительной обработке, настройке параметров и включении внешних данных для лучшей интерпретации аномалий и прогнозирования. Код хорошо структурирован и использует надежные библиотеки, обеспечивая прочную основу для дальнейшего анализа временных рядов.
